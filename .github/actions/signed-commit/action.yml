#
# This action enables to perform signed commits. 
# It uses the crazy-max/ghaction-import-gpg action to import the GPG key and set up the git configuration for signing commits.
# The action then performs a manual git commit and push to the specified branch.
#
# HOW TO USE:
#
# To call this reusable action, copy the code between === lines to workflow file,
# uncomment and adjust "uses" as needed (use the latest tag available).
# ======================================================================
# on:
#
#     (...)
#     steps:
#     (...)
#       - name: Commit changes Signed
#         uses: OutSystems/rd.github-reusable-workflows/.github/actions/signed-commit@vTagVersion
#         with:
#           commit-branch: ${{ BRANCH_NAME }}
#           commit-message: ${{ COMMIT_MESSAGE }}
#           commit-new-files: ${{ true || false }}
#           gpg-priv-key: ${{ GPG_SIGN_KEY }}
#           gpg-pass-phrase: ${{ GPG_PASSPHRASE }}
#
# ======================================================================
#

name: Signed GPG Commit
description: 'Prepare and sign the commit signed'
inputs:
    commit-branch:
        description: 'Branch where to commit.'
        required: true
        default: ''
    commit-message:
        description: 'Commit message.'
        required: true
        default: ''
    commit-new-files:
        description: 'Defines if a `git add.` should be made or not.'
        required: false
        default: false
    gpg-priv-key:
        description: 'GPG Private key.'
        required: true
        default: ''
    gpg-pass-phrase:
        description: 'GPG passphrase.'
        required: false
        default: '""'

runs:
    using: composite
    steps:
        - name: Validate GPG inputs
          shell: bash
          run: |
              if [ -z "${{ inputs.gpg-priv-key }}" ]; then
                  echo "::error::GPG private key is empty!"
                  exit 1
              fi
              if [ -z "${{ inputs.gpg-pass-phrase }}" ] || [ "${{ inputs.gpg-pass-phrase }}" = '""' ]; then
                  echo "::warning::GPG passphrase appears to be empty - this may cause signing to fail"
              fi
              echo "GPG inputs validated"

        - name: Configure GPG for non-interactive use
          shell: bash
          run: |
              mkdir -p ~/.gnupg
              chmod 700 ~/.gnupg
              echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
              echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
              gpgconf --kill gpg-agent || true

        - name: Import and load GPG key
          uses: crazy-max/ghaction-import-gpg@cb9bde2e2525e640591a934b1fd28eef1dcaf5e5 # v6.2.0
          with:
              gpg_private_key: ${{ inputs.gpg-priv-key }}
              passphrase: ${{ inputs.gpg-pass-phrase }}
              git_user_signingkey: true
              git_commit_gpgsign: true

        - name: Add new files (if needed)
          shell: bash
          if: ${{ inputs.commit-new-files == 'true' }}
          run: |
              git add .

        - name: Manual git commit
          shell: bash
          run: |
              git commit -m "${{ inputs.commit-message }}"
              git push origin ${{ inputs.commit-branch }}
